<!DOCTYPE html>
<html>
    <head>
        <title>Codevelup</title>
        <!-- Site Settings -->
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Quicksand|Roboto" rel="stylesheet">  

        <!-- Font Awesome -->
        <link rel="stylesheet" href="fontawesome-free-5.12.1-web/css/all.min.css">   

        <!-- Style -->
        <link rel="stylesheet" type="text/css" href="stylesheet.css">

        
        <!-- Scripts -->
        <script src="papaparse.min.js"></script> 
    </head>

    <body>
        <h1>Resources Page</h1> 
        <section>
            TODO: Create dropdown menus for category, price, and platform. Make CSV Reader and Table Parser. Add Function to delete tables and filter/hide rows.
            <p>
                Category: 
                <select id="category" onchange="SelectCategory()">
                    <option value="">Category</option>
                    <option value="engines">Game Engine</option>
                    <option value="video">Video</option>
                    <option value="audio">Audio</option>
                    <option value="publisher">Publisher</option>
                </select>
            </p>
            <p>
                Price: 
                <select id="category" onchange="SelectPrice()">
                    <option value="">Price</option>
                    <option value="free">Free</option>
                    <option value="trial">Trial</option>
                    <option value="paid">Paid</option>
                    <option value="subscription">Subscription</option>
                    <option value="royalty">Royalty</option>
                </select>
            </p>
            <p>
                Platform: 
                <select id="category" onchange="SelectPlatform()">
                    <option value="">Platform</option>
                    <option value="windows">Windows</option>
                    <option value="mac">Mac</option>
                    <option value="linux">Linux</option>
                    <option value="ios">iOS</option>
                    <option value="android">Android</option>
                </select>
            </p>
        </section>
        
        <p id="demo"></p>

        <p id="papa"></p>
        

        <div id="showData">
            <!-- Table is added here -->
        </div>

        <!--
        <p id="demo"></p>
        <p id="demo1"></p>
        <p id="demo2"></p>
        -->

    </body>

    <script>
        var filepath;
        var csvdata;

        /*
        Papa.parse(data, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                data = results;
            }
        });
        */

        function SelectCategory()
        {
            //filepath = "csv/"+ doc.getElementById("category").value;
            filepath = document.getElementById("category").value+".csv";
            //Upload();
            document.getElementById("demo").innerHTML = filepath;

            loadDoc(filepath);
        }
        
        /*
        function loadDoc() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    //document.getElementById("demo1").innerHTML = this.responseText;
                    document.getElementById("demo2").innerHTML = this.responseText;;
                }
            };
            document.getElementById("demo1").innerHTML = "Hi";

            xhttp.open("GET", "asdf.txt", true);
            xhttp.send();
        }

        function loadDoc1() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("demo2").innerHTML = this.responseText;
                }
            };
            xhttp.open("GET", "engines.csv", true);
            xhttp.send();
        }
        */
        
        function loadDoc(filepath) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("demo").innerHTML = this.responseText;
                    csvdata = Papa.parse(this.responseText);
                    console.log(csvdata);
                    CreateTable(csvdata);
                }
            };
            xhttp.open("GET", filepath, true);
            xhttp.send();
        }

        const csvStringToArray = (strData, header=true) =>
        {
            //const objPattern = new RegExp(("(\\,|\\r?\\n|\\r|^)(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\\,\\r\\n]*))"),"gi");
            const objPattern = new RegExp(("(\\,|\\r?\\n|\\r|^)(?:\"((?:\\\\.|\"\"|[^\\\\\"])*)\"|([^\\,\"\\r\\n]*))"),"gi");
            let arrMatches = null, arrData = [[]];
            while (arrMatches = objPattern.exec(strData)){
                if (arrMatches[1].length && arrMatches[1] !== ",") arrData.push([]);
                arrData[arrData.length - 1].push(arrMatches[2] ? 
                    arrMatches[2].replace(new RegExp( "[\\\\\"](.)", "g" ), '$1') :
                    arrMatches[3]);
            }
            if (header) {
                hData = arrData.shift();
                hashData = arrData.map(row => {
                    let i = 0;
                    return hData.reduce(
                        (acc, key) => { 
                            acc[key] = row[i++]; 
                            return acc; 
                        },
                        {}
                    );
                });
                return hashData;
            } else {
                return arrData;
            }
        }

        function CreateTable(arrItems){
            /*
            var arrItems = [];      // THE ARRAY TO STORE JSON ITEMS.
            $.each(data, function (index, value) {
                arrItems.push(value);       // PUSH THE VALUES INSIDE THE ARRAY.
                console.log(index, value);
            });
            */
            // EXTRACT KEY FOR TABLE HEADER.
            var col = [];
            for (var i = 0; i < arrItems.length; i++) {
                for (var key in arrItems[i]) {
                    console.log(key, arrItems[i], arrItems[i][key]);
                    if (col.indexOf(key) === -1) {
                        col.push(key);
                    }
                }
            }

            // CREATE DYNAMIC TABLE.
            var table = document.createElement("table");

            //added by me
            table.setAttribute("id", "myTable");

            // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

            var tr = table.insertRow(-1);                   // TABLE ROW.

            for (var i = 0; i < col.length; i++) {
                if(i==1){continue;}
                var th = document.createElement("th");      // TABLE HEADER.
                th.innerHTML = col[i];
                tr.appendChild(th);
            }

            // ADD JSON DATA TO THE TABLE AS ROWS.
            for (var i = 0; i < arrItems.length; i++) {

                tr = table.insertRow(-1);

                for (var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    if(j==0){   
                        tabCell.innerHTML = "<a href=\"" + arrItems[i][col[1]] + "\">"+arrItems[i][col[0]]+"</a>";
                        j++;
                        //tabCell.innerHTML = "<a href=\"" + arrItems[i][col[j]].Link + "\">"+arrItems[i][col[j]].Name+"</a>";
                    }
                    else{
                        tabCell.innerHTML = arrItems[i][col[j]];
                    }
                }
            }

            // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
            var divContainer = document.getElementById("showData");
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
        }
    </script>
</html>
